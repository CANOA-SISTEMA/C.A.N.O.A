<script>
  const PASSWORD = "hegemol";
  const LEN = 7;
  const MAX_ATTEMPTS = 3;

  const input = document.getElementById("input");
  const boxes = document.getElementById("boxes");
  const glitch = document.getElementById("glitch");
  const downloadBox = document.getElementById("downloadBox");
  const percentText = document.getElementById("percentText");
  const barFill = document.getElementById("barFill");
  const music = document.getElementById("music");
  const titleText = document.getElementById("titleText");
  const symbol = document.getElementById("symbol");
  const mainWrap = document.getElementById("mainWrap");

  let attempts = 0;

  titleText.textContent = `${MAX_ATTEMPTS} chances`;

  // Criar boxes
  for (let i = 0; i < LEN; i++) {
    const d = document.createElement("div");
    d.className = "char";
    boxes.appendChild(d);
  }

  function updateBoxes(v) {
    const length = v ? v.length : 0;
    [...boxes.children].forEach((b, i) => {
      b.classList.toggle("filled", i < length);
      b.textContent = i < length ? "‚Ä¢" : "";
    });
  }

  document.addEventListener('click', () => {
    try { input.focus(); } catch (e) {}
  });

  document.addEventListener("click", () => {
    music.play().then(()=>{
      music.pause();
      music.currentTime = 0;
    }).catch(()=>{});
  }, { once: true });

  input.addEventListener("input", e => {
    const val = e.target.value.slice(0, LEN);
    e.target.value = val;
    updateBoxes(val);
  });

  input.value = "";
  setTimeout(()=>{ try{ input.focus(); }catch(e){} }, 50);

  function updateTitleRemaining(remaining) {
    if (remaining > 1) titleText.textContent = `${remaining} chances`;
    else if (remaining === 1) titleText.textContent = `1 chance`;
    else titleText.textContent = `0 chances`;
  }

  input.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      const v = input.value;
      if (v.length !== LEN) return;

      if (v.toLowerCase() === PASSWORD) {
        alert("ACESSO LIBERADO");
        return;
      }

      attempts++;
      input.value = "";
      updateBoxes("");

      const remaining = MAX_ATTEMPTS - attempts;
      updateTitleRemaining(remaining);

      if (attempts === MAX_ATTEMPTS) {
        updateTitleRemaining(0);
        activateChaos();
      }
    }
  });

  function activateChaos() {

    input.disabled = true;
    input.style.display = 'none';
    mainWrap.classList.add('hidden');

    document.body.classList.add('chaos', 'shake');
    glitch.classList.add('show');
    downloadBox.classList.add('show');

    symbol.classList.add('show');

    music.currentTime = 0;

    music.play().then(() => {
      syncWithAudio();
    });

    music.addEventListener("ended", () => {
      barFill.style.width = "100%";
      percentText.textContent = "100%";

      setTimeout(() => {
        downloadBox.classList.remove('show');
        glitch.classList.remove('show');
        document.body.classList.remove('shake');
      }, 300);
    });
  }

  // üî• FUN√á√ÉO CORRIGIDA ‚Äì AGORA USA O TEMPO REAL DO √ÅUDIO
  function syncWithAudio() {

    function update() {

      if (!music.duration || isNaN(music.duration)) {
        requestAnimationFrame(update);
        return;
      }

      const percent = (music.currentTime / music.duration) * 100;

      barFill.style.width = percent + "%";
      percentText.textContent = Math.floor(percent) + "%";

      if (!music.paused && !music.ended) {
        requestAnimationFrame(update);
      } else {
        barFill.style.width = "100%";
        percentText.textContent = "100%";
      }
    }

    requestAnimationFrame(update);
  }

</script>
