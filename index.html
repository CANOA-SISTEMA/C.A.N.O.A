<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>3 chances</title>
<style>
:root{
  --bg:#000;
  --accent:#ff3b3b;
  --muted:#777;
  --box-h:45px;
  --box-w:35px;
}

html,body{
  height:100%;
  margin:0;
  background:var(--bg);
  color:#ddd;
  font-family:system-ui,monospace;
  overflow:hidden;
}

.wrap{
  height:100%;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  gap:22px;
}

.title{
  font-size:28px;
  text-shadow:2px 0 var(--accent), -2px 0 cyan;
}

/* caixas */
.password-line{
  display:flex;
  gap:12px;
}
.char{
  width:var(--box-w);
  height:var(--box-h);
  border-bottom:3px solid #444;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  color:transparent; /* escondemos o caractere */
}
.char.filled{
  border-bottom-color:var(--accent);
}

/* sr-only mais acessível */
.sr-only{
  position: absolute !important;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0 0 0 0);
  white-space: nowrap;
  border: 0;
}

/* shake */
.shake{ animation:shake .35s }
@keyframes shake{
  0%{transform:translate(2px,2px)}
  50%{transform:translate(-3px,2px)}
  100%{transform:none}
}

/* OVERLAY */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:none;
  z-index:999;
  align-items:center;
  justify-content:center;
  text-align:center;
  color:#fff;
  padding:20px;
}
.overlay.show{display:flex}

/* PROGRESS */
.progress{
  position:fixed;
  bottom:0;
  left:0;
  height:6px;
  width:0%;
  background:var(--accent);
  z-index:10000;
  display:none;
}

/* SCREEN GLITCH */
.screen-glitch{
  position:fixed;
  inset:0;
  pointer-events:none;
  opacity:0;
  z-index:998;
}

.screen-glitch.active{
  opacity:1;
  animation:screenGlitch .8s linear;
}
@keyframes screenGlitch{
  0%{transform:translate(0)}
  30%{transform:translate(-5px,3px)}
  60%{transform:translate(4px,-2px)}
  100%{transform:none}
}

/* pequeno aviso de contexto inseguro */
.notice{
  background:#111;
  color:#fdd;
  padding:8px 12px;
  border-radius:6px;
  font-size:13px;
  border:1px solid rgba(255,59,59,.12);
}
</style>
</head>
<body>

<div class="wrap" id="wrap">
  <div class="title">3 chances</div>

  <div class="password-line" id="boxes" aria-hidden="true"></div>

  <!-- input real, escondido mas disponível para leitores -->
  <input id="input" class="sr-only" type="password" maxlength="7" inputmode="text" autocomplete="off"
         aria-label="Digite a senha de 7 caracteres">
  <div id="ariaStatus" class="sr-only" aria-live="polite"></div>

  <div id="insecureNotice" style="display:none;margin-top:12px"></div>
</div>

<div class="overlay" id="overlay" role="status" aria-live="polite">
  <div>
    <h2 id="overlayTitle">Acesso bloqueado</h2>
    <p id="overlayMsg">Aguarde…</p>
    <p style="margin-top:8px"><button id="overlayCancel" style="display:none">Cancelar</button></p>
  </div>
</div>

<div class="progress" id="progress" aria-hidden="true"></div>
<div class="screen-glitch" id="screenGlitch" aria-hidden="true"></div>

<script>
/* CONFIG */
const PASS_HASH = "f97ac9e04309ce602c5026a251aa2b4523523175ce13b3598399db03b263b4ac";
const MAX_ATTEMPTS = 3;
const LEN = 7;

/* Elementos */
const input = document.getElementById("input");
const boxes = document.getElementById("boxes");
const overlay = document.getElementById("overlay");
const overlayTitle = document.getElementById("overlayTitle");
const overlayMsg = document.getElementById("overlayMsg");
const progress = document.getElementById("progress");
const wrap = document.getElementById("wrap");
const screenGlitch = document.getElementById("screenGlitch");
const ariaStatus = document.getElementById("ariaStatus");
const insecureNotice = document.getElementById("insecureNotice");

let attempts = 0;
let progressTimer = null;

/* --- WebAudio setup (cria contexto ao primeiro gesto para evitar bloqueio) --- */
let audioCtx = null;
function ensureAudioContext() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
}

/* toca uma sequência curta (melodia) — sem dependência de iframe/YouTube */
async function playMelody() {
  try {
    ensureAudioContext();
    if (audioCtx.state === 'suspended') await audioCtx.resume();

    const t = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'sine';
    osc.connect(gain);
    gain.connect(audioCtx.destination);

    gain.gain.setValueAtTime(0, t);
    gain.gain.linearRampToValueAtTime(0.15, t + 0.01);
    osc.frequency.setValueAtTime(440, t);
    osc.frequency.linearRampToValueAtTime(660, t + 0.12);

    osc.start(t);
    gain.gain.exponentialRampToValueAtTime(0.0001, t + 2.0);
    osc.stop(t + 2.05);
  } catch (err) {
    console.warn("Audio failed:", err);
  }
}

/* cria as caixas visuais */
for (let i = 0; i < LEN; i++) {
  const d = document.createElement("div");
  d.className = "char";
  d.setAttribute('data-index', i);
  boxes.appendChild(d);
}

/* atualiza o estado visual das caixas */
function updateBoxes(v) {
  const s = String(v || "");
  [...boxes.children].forEach((b, i) => {
    b.classList.toggle("filled", i < s.length);
    b.textContent = i < s.length ? "•" : ""; // mostra ponto quando preenchido
  });
}

/* sha256 (subtle) */
async function sha256(t) {
  const enc = new TextEncoder().encode(t);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2, '0')).join('');
}

/* mostra overlay e bloqueia entrada, mostra progresso */
function chaos() {
  overlay.classList.add("show");
  overlayTitle.textContent = "Acesso bloqueado";
  overlayMsg.textContent = "Aguarde…";

  screenGlitch.classList.add("active");
  setTimeout(() => screenGlitch.classList.remove("active"), 800);

  // bloquear input
  input.disabled = true;
  wrap.classList.add("shake");

  // progress visual, 5s por padrão
  progress.style.display = "block";
  progress.style.width = "0%";
  let start = performance.now();
  const duration = 5000;
  if (progressTimer) cancelAnimationFrame(progressTimer);

  function step(now) {
    const elapsed = now - start;
    const pct = Math.min(100, Math.round((elapsed / duration) * 100));
    progress.style.width = pct + "%";
    if (pct < 100) {
      progressTimer = requestAnimationFrame(step);
    } else {
      progress.style.display = "none";
      overlay.classList.remove("show");
      input.disabled = false;
      attempts = 0;
      updateBoxes("");
      ariaStatus.textContent = "Bloqueio finalizado. Você pode tentar novamente.";
    }
  }
  progressTimer = requestAnimationFrame(step);

  // tocar melodia (WebAudio) — reuso: evita criar iframes e problemas de autoplay em iframes ocultos
  playMelody();
}

/* tratamento de input: atualiza boxes e evita caracteres excessivos */
input.addEventListener("input", (e) => {
  // limite de caracteres já imposto pelo maxlength, mas normalizamos
  const val = e.target.value.slice(0, LEN);
  e.target.value = val;
  updateBoxes(val);
});

/* também aceita paste (colado) garantindo tamanho */
input.addEventListener("paste", (ev) => {
  ev.preventDefault();
  const text = (ev.clipboardData || window.clipboardData).getData('text').slice(0, LEN);
  input.value = text;
  updateBoxes(text);
});

/* pressionar Enter verifica senha */
input.addEventListener("keydown", async (e) => {
  if (e.key === "Enter") {
    const v = input.value || "";
    if (v.length !== LEN) {
      // feedback
      ariaStatus.textContent = `Senha deve ter ${LEN} caracteres.`;
      return;
    }

    // comparar hash (lembre: PASS_HASH no cliente é visível)
    try {
      const h = await sha256(v);
      if (h === PASS_HASH) {
        attempts = 0;
        ariaStatus.textContent = "Acesso liberado.";
        // feedback visual simples
        alert("Acesso liberado");
        input.value = "";
        updateBoxes("");
      } else {
        attempts++;
        // animação de shake para feedback
        wrap.classList.add("shake");
        setTimeout(() => wrap.classList.remove("shake"), 350);

        ariaStatus.textContent = `Senha incorreta. Tentativa ${attempts} de ${MAX_ATTEMPTS}.`;
        input.value = "";
        updateBoxes("");

        if (attempts >= MAX_ATTEMPTS) {
          chaos();
        }
      }
    } catch (err) {
      console.error("Erro no hashing:", err);
      ariaStatus.textContent = "Erro interno ao processar. Recarregue a página.";
    }
  }
});

/* foco no click */
wrap.addEventListener("click", () => {
  input.focus();
});

/* foco ao carregar (se permitido) e detecta contexto inseguro */
window.addEventListener("load", () => {
  input.focus();

  // detecta contexto inseguro (crypto.subtle exige secure context)
  const isSecure = location.protocol === 'https:' || location.hostname === 'localhost';
  if (!isSecure) {
    insecureNotice.style.display = 'block';
    insecureNotice.className = 'notice';
    insecureNotice.textContent = 'Aviso: para que a verificação funcione corretamente, abra esta página via HTTPS (ex.: https://<usuario>.github.io/seu-repo/). Em "blob" do GitHub ou file:// não funcionará.';
    ariaStatus.textContent = 'Contexto inseguro detectado. Use GitHub Pages (https) para funcionamento completo.';
  }

  // Prepara áudio apenas após interação do usuário para evitar bloqueio por autoplay em alguns navegadores
  const resumeAudio = () => {
    ensureAudioContext();
    if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
    window.removeEventListener('click', resumeAudio);
    window.removeEventListener('keydown', resumeAudio);
  };
  window.addEventListener('click', resumeAudio);
  window.addEventListener('keydown', resumeAudio);
});
</script>
</body>
</html>
